name: Build

on:
  push:
    branches: [main]
    tags: ["v*"]
  pull_request:
    branches: [main]

env:
  PDFIUM_VERSION: "7690"

jobs:
  # ─────────────────────────────────────────────────────────────────────────
  #  Build all platforms on a single Ubuntu runner.
  #
  #  Android: CMake + pre-installed NDK
  #  iOS:     clang cross-compilation (no Xcode / macOS needed)
  # ─────────────────────────────────────────────────────────────────────────
  build:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Install LLVM tools
        run: sudo apt-get update && sudo apt-get install -y --no-install-recommends clang llvm lld

      - name: Cache PDFium downloads
        uses: actions/cache@v4
        with:
          path: third_party/pdfium
          key: pdfium-${{ env.PDFIUM_VERSION }}

      - name: Build Android + iOS
        env:
          USE_DOCKER: "0"
          ANDROID_NDK_HOME: ${{ env.ANDROID_NDK_LATEST_HOME }}
        run: ./scripts/build.sh

      - name: Verify artifacts
        run: |
          for abi in arm64-v8a armeabi-v7a x86_64 x86; do
            test -f "dist/android/${abi}/lib/libpdfium_wrapper.a" || { echo "Missing: android/${abi}/libpdfium_wrapper.a"; exit 1; }
            test -f "dist/android/${abi}/lib/libpdfium.so"        || { echo "Missing: android/${abi}/libpdfium.so"; exit 1; }
          done
          for arch in arm64 x86_64; do
            test -f "dist/ios/${arch}/lib/libpdfium_wrapper.a"  || { echo "Missing: ios/${arch}/libpdfium_wrapper.a"; exit 1; }
            test -f "dist/ios/${arch}/lib/libpdfium.dylib"      || { echo "Missing: ios/${arch}/libpdfium.dylib"; exit 1; }
          done
          test -f dist/include/pdfium_wrapper.h || { echo "Missing: pdfium_wrapper.h"; exit 1; }
          test -f dist/include/fpdfview.h       || { echo "Missing: fpdfview.h (PDFium headers)"; exit 1; }
          test -f dist/pdf-engine.tar.gz        || { echo "Missing: pdf-engine.tar.gz bundle"; exit 1; }
          echo "All artifacts verified."

      - name: Upload bundle
        uses: actions/upload-artifact@v4
        with:
          name: pdf-engine
          path: dist/pdf-engine.tar.gz
          retention-days: 30

  # ─────────────────────────────────────────────────────────────────────────
  #  Release — upload the bundle when a version tag is pushed
  # ─────────────────────────────────────────────────────────────────────────
  release:
    if: startsWith(github.ref, 'refs/tags/v')
    needs: [build]
    runs-on: ubuntu-latest
    permissions:
      contents: write

    steps:
      - name: Download bundle
        uses: actions/download-artifact@v4
        with:
          name: pdf-engine
          path: .

      - name: Rename bundle for release
        run: mv pdf-engine.tar.gz pdf-engine-${{ github.ref_name }}.tar.gz

      - name: Create GitHub Release
        uses: softprops/action-gh-release@v2
        with:
          files: pdf-engine-${{ github.ref_name }}.tar.gz
          generate_release_notes: true
          body: |
            ## pdf-engine ${{ github.ref_name }}

            Pre-built PDFium + wrapper libraries for iOS and Android.

            ### Usage

            Download and extract `pdf-engine-${{ github.ref_name }}.tar.gz`:

            ```
            include/            pdfium_wrapper.h + PDFium headers
            android/<abi>/lib/  libpdfium_wrapper.a + libpdfium.so
            ios/<arch>/lib/     libpdfium_wrapper.a + libpdfium.dylib
            ```

            Point your build system at the extracted directory and link against
            `pdfium_wrapper` (static) and `pdfium` (dynamic).
