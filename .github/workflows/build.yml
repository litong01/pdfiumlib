name: Build

on:
  push:
    branches: [main]
    tags: ["v*"]
  pull_request:
    branches: [main]

env:
  PDFIUM_VERSION: "6721"

jobs:
  # ─────────────────────────────────────────────────────────────────────────
  #  Build all platforms on a single Ubuntu runner.
  #
  #  Android: CMake + pre-installed NDK
  #  iOS:     clang cross-compilation (no Xcode / macOS needed)
  # ─────────────────────────────────────────────────────────────────────────
  build:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Install LLVM tools
        run: sudo apt-get update && sudo apt-get install -y --no-install-recommends clang llvm lld

      - name: Cache PDFium downloads
        uses: actions/cache@v4
        with:
          path: third_party/pdfium
          key: pdfium-${{ env.PDFIUM_VERSION }}

      - name: Build Android + iOS
        env:
          USE_DOCKER: "0"
          ANDROID_NDK_HOME: ${{ env.ANDROID_NDK_LATEST_HOME }}
        run: ./scripts/build.sh

      - name: Verify artifacts
        run: |
          for abi in arm64-v8a armeabi-v7a x86_64 x86; do
            test -f "dist/android/${abi}/lib/libpdfium_wrapper.a" || { echo "Missing: android/${abi}/libpdfium_wrapper.a"; exit 1; }
            test -f "dist/android/${abi}/lib/libpdfium.a"         || { echo "Missing: android/${abi}/libpdfium.a"; exit 1; }
          done
          for arch in arm64 x86_64; do
            test -f "dist/ios/${arch}/lib/libpdfium_wrapper.a" || { echo "Missing: ios/${arch}/libpdfium_wrapper.a"; exit 1; }
            test -f "dist/ios/${arch}/lib/libpdfium.a"         || { echo "Missing: ios/${arch}/libpdfium.a"; exit 1; }
          done
          test -f dist/include/pdfium_wrapper.h || { echo "Missing: pdfium_wrapper.h"; exit 1; }
          echo "All artifacts verified."

      - name: Upload artifacts
        uses: actions/upload-artifact@v4
        with:
          name: pdf-engine-libs
          path: dist/
          retention-days: 30

  # ─────────────────────────────────────────────────────────────────────────
  #  Release — package and upload when a version tag is pushed
  # ─────────────────────────────────────────────────────────────────────────
  release:
    if: startsWith(github.ref, 'refs/tags/v')
    needs: [build]
    runs-on: ubuntu-latest
    permissions:
      contents: write

    steps:
      - name: Download artifacts
        uses: actions/download-artifact@v4
        with:
          name: pdf-engine-libs
          path: dist/

      - name: Package release archive
        run: |
          echo "Contents of dist/:"
          find dist -type f | sort
          tar czf pdf-engine-${{ github.ref_name }}.tar.gz dist/

      - name: Create GitHub Release
        uses: softprops/action-gh-release@v2
        with:
          files: pdf-engine-${{ github.ref_name }}.tar.gz
          generate_release_notes: true
