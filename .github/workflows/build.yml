name: Build

on:
  push:
    branches: [main]
    tags: ["v*"]
  pull_request:
    branches: [main]
  workflow_dispatch:
    inputs:
      target:
        description: "Platform to build"
        required: false
        default: "all"
        type: choice
        options:
          - all
          - android
          - ios
      version:
        description: "Release version (e.g. v1.0.0). Leave empty to skip release."
        required: false
        default: ""
        type: string

env:
  PDFIUM_VERSION: "7690"

jobs:
  # ─────────────────────────────────────────────────────────────────────────
  #  Build all platforms on a single Ubuntu runner.
  #
  #  Android: CMake + pre-installed NDK
  #  iOS:     clang cross-compilation (no Xcode / macOS needed)
  # ─────────────────────────────────────────────────────────────────────────
  build:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Install LLVM tools
        run: sudo apt-get update && sudo apt-get install -y --no-install-recommends clang llvm lld

      - name: Cache PDFium downloads
        uses: actions/cache@v4
        with:
          path: third_party/pdfium
          key: pdfium-${{ env.PDFIUM_VERSION }}

      - name: Build
        env:
          USE_DOCKER: "0"
          ANDROID_NDK_HOME: ${{ env.ANDROID_NDK_LATEST_HOME }}
        run: ./scripts/build.sh ${{ inputs.target || 'all' }}

      - name: Verify artifacts
        env:
          BUILD_TARGET: ${{ inputs.target || 'all' }}
        run: |
          set -euo pipefail
          ERRORS=0

          check() {
            local label="$1" file="$2"
            if [[ ! -f "${file}" ]]; then
              echo "FAIL: missing ${label} (${file})"
              ERRORS=$((ERRORS + 1))
              return 1
            fi
            local size
            size=$(stat -c%s "${file}" 2>/dev/null || stat -f%z "${file}")
            if [[ "${size}" -lt 1024 ]]; then
              echo "FAIL: ${label} is suspiciously small (${size} bytes)"
              ERRORS=$((ERRORS + 1))
              return 1
            fi
            echo "  OK: ${label} ($(numfmt --to=iec ${size}))"
          }

          echo "── File presence & size ──"
          if [[ "${BUILD_TARGET}" == "all" || "${BUILD_TARGET}" == "android" ]]; then
            for abi in arm64-v8a armeabi-v7a x86_64 x86; do
              check "android/${abi}/libpdfium_wrapper.a" "dist/android/${abi}/lib/libpdfium_wrapper.a"
              check "android/${abi}/libpdfium.so"        "dist/android/${abi}/lib/libpdfium.so"
            done
          fi
          if [[ "${BUILD_TARGET}" == "all" || "${BUILD_TARGET}" == "ios" ]]; then
            for arch in arm64 x86_64; do
              check "ios/${arch}/libpdfium_wrapper.a"  "dist/ios/${arch}/lib/libpdfium_wrapper.a"
              check "ios/${arch}/libpdfium.dylib"      "dist/ios/${arch}/lib/libpdfium.dylib"
            done
          fi
          check "pdfium_wrapper.h" "dist/include/pdfium_wrapper.h"
          check "fpdfview.h"       "dist/include/fpdfview.h"
          check "pdf-engine.tar.gz" "dist/pdf-engine.tar.gz"

          echo ""
          echo "── File formats ──"
          if [[ "${BUILD_TARGET}" == "all" || "${BUILD_TARGET}" == "android" ]]; then
            echo "(Android: should be ELF)"
            for abi in arm64-v8a armeabi-v7a x86_64 x86; do
              FMT=$(file "dist/android/${abi}/lib/libpdfium.so")
              echo "  android/${abi}/libpdfium.so: ${FMT}"
              echo "${FMT}" | grep -qi "ELF" || { echo "FAIL: expected ELF"; ERRORS=$((ERRORS + 1)); }
            done
          fi
          if [[ "${BUILD_TARGET}" == "all" || "${BUILD_TARGET}" == "ios" ]]; then
            echo "(iOS: should be Mach-O)"
            for arch in arm64 x86_64; do
              FMT=$(file "dist/ios/${arch}/lib/libpdfium.dylib")
              echo "  ios/${arch}/libpdfium.dylib: ${FMT}"
              echo "${FMT}" | grep -qi "Mach-O" || { echo "FAIL: expected Mach-O"; ERRORS=$((ERRORS + 1)); }
            done
          fi

          echo ""
          echo "── Architecture check ──"
          if [[ "${BUILD_TARGET}" == "all" || "${BUILD_TARGET}" == "android" ]]; then
            file "dist/android/arm64-v8a/lib/libpdfium.so"  | grep -qi "aarch64\|arm64"  || { echo "FAIL: arm64-v8a not aarch64"; ERRORS=$((ERRORS + 1)); }
            file "dist/android/armeabi-v7a/lib/libpdfium.so" | grep -qi "arm\|32"          || { echo "FAIL: armeabi-v7a not ARM"; ERRORS=$((ERRORS + 1)); }
            file "dist/android/x86_64/lib/libpdfium.so"     | grep -qi "x86.64\|x86-64"  || { echo "FAIL: x86_64 not x86-64"; ERRORS=$((ERRORS + 1)); }
            file "dist/android/x86/lib/libpdfium.so"        | grep -qi "Intel\|386\|x86"  || { echo "FAIL: x86 not x86"; ERRORS=$((ERRORS + 1)); }
            echo "  Android architectures OK."
          fi

          echo ""
          echo "── Wrapper symbols (should export pdfium_init, pdfium_render_page, etc.) ──"
          EXPECTED_SYMBOLS="pdfium_init pdfium_destroy pdfium_load_document pdfium_close_document pdfium_render_page pdfium_free_bitmap"
          if [[ "${BUILD_TARGET}" == "all" || "${BUILD_TARGET}" == "android" ]]; then
            SAMPLE_LIB="dist/android/arm64-v8a/lib/libpdfium_wrapper.a"
          else
            SAMPLE_LIB="dist/ios/arm64/lib/libpdfium_wrapper.a"
          fi
          if command -v llvm-nm &>/dev/null; then
            NM_CMD="llvm-nm"
          elif command -v nm &>/dev/null; then
            NM_CMD="nm"
          else
            NM_CMD=""
            echo "  SKIP: no nm/llvm-nm available"
          fi
          if [[ -n "${NM_CMD}" ]]; then
            SYMS=$(${NM_CMD} "${SAMPLE_LIB}" 2>/dev/null || true)
            for sym in ${EXPECTED_SYMBOLS}; do
              if echo "${SYMS}" | grep -q "${sym}"; then
                echo "  OK: ${sym}"
              else
                echo "  FAIL: symbol '${sym}' not found in wrapper"
                ERRORS=$((ERRORS + 1))
              fi
            done
          fi

          echo ""
          echo "── Bundle contents ──"
          BUNDLE_LIST=$(tar tzf dist/pdf-engine.tar.gz)
          BUNDLE_COUNT=$(echo "${BUNDLE_LIST}" | wc -l)
          echo "${BUNDLE_LIST}" | head -30
          echo "  ... (${BUNDLE_COUNT} entries total)"

          echo ""
          if [[ ${ERRORS} -gt 0 ]]; then
            echo "VERIFICATION FAILED: ${ERRORS} error(s)"
            exit 1
          fi
          echo "All artifacts verified successfully."

      - name: Upload bundle
        uses: actions/upload-artifact@v4
        with:
          name: pdf-engine
          path: dist/pdf-engine.tar.gz
          retention-days: 30

  # ─────────────────────────────────────────────────────────────────────────
  #  Release — upload the bundle when a version tag is pushed
  # ─────────────────────────────────────────────────────────────────────────
  release:
    if: startsWith(github.ref, 'refs/tags/v') || (github.event_name == 'workflow_dispatch' && inputs.version != '')
    needs: [build]
    runs-on: ubuntu-latest
    permissions:
      contents: write

    steps:
      - name: Download bundle
        uses: actions/download-artifact@v4
        with:
          name: pdf-engine
          path: .

      - name: Determine version tag
        id: version
        run: |
          if [[ -n "${{ inputs.version }}" ]]; then
            echo "tag=${{ inputs.version }}" >> "$GITHUB_OUTPUT"
          else
            echo "tag=${{ github.ref_name }}" >> "$GITHUB_OUTPUT"
          fi

      - name: Rename bundle for release
        run: mv pdf-engine.tar.gz pdf-engine-${{ steps.version.outputs.tag }}.tar.gz

      - name: Create GitHub Release
        uses: softprops/action-gh-release@v2
        with:
          tag_name: ${{ steps.version.outputs.tag }}
          files: pdf-engine-${{ steps.version.outputs.tag }}.tar.gz
          generate_release_notes: true
          body: |
            ## pdf-engine ${{ steps.version.outputs.tag }}

            Pre-built PDFium + wrapper libraries for iOS and Android.

            ### Usage

            Download and extract `pdf-engine-${{ steps.version.outputs.tag }}.tar.gz`:

            ```
            include/            pdfium_wrapper.h + PDFium headers
            android/<abi>/lib/  libpdfium_wrapper.a + libpdfium.so
            ios/<arch>/lib/     libpdfium_wrapper.a + libpdfium.dylib
            ```

            Point your build system at the extracted directory and link against
            `pdfium_wrapper` (static) and `pdfium` (dynamic).
